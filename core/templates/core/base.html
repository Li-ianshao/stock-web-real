<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>è‚¡ç¥¨åˆ†æå¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- å°è¦½åˆ— -->
    <nav class="bg-white shadow p-4 flex justify-between items-center">
        <h1 class="text-xl font-bold text-indigo-600">S&P 500 æŠ€è¡“èˆ‡é…æ¯åˆ†æå¹³å°</h1>
        <div class="text-sm text-gray-700">
            æ‚¨å¥½ï¼Œ{{ request.user.username }} |
            <form method="post" action="{% url 'logout' %}" class="inline">
                {% csrf_token %}
                <button type="submit" class="text-sm text-red-500 hover:text-red-700 transition">ç™»å‡º</button>
            </form>
            <a href="{% url 'clear_cache' %}" class="ml-4 text-sm text-yellow-600 hover:text-yellow-800 transition">
                æ¸…é™¤picoæª”æ¡ˆ
            </a>
        </div>
    </nav>

    <!-- é ç±¤æŒ‰éˆ•å€ -->
    <div class="bg-indigo-100 p-4 flex flex-wrap justify-center space-x-2 text-sm font-medium">
        {% with request.path as path %}
            {% if path == '/core/dividend/' %}
                <span class="px-4 py-2 bg-white border-b-4 border-indigo-500 text-indigo-700 font-bold rounded shadow">é«˜æ®–åˆ©ç‡</span>
            {% else %}
                <a href="{% url 'tab_dividend' %}" class="px-4 py-2 bg-white rounded shadow hover:bg-indigo-100">é«˜æ®–åˆ©ç‡</a>
            {% endif %}

            {% if path == '/core/rsi/' %}
                <span class="px-4 py-2 bg-white border-b-4 border-indigo-500 text-indigo-700 font-bold rounded shadow">RSI è­¦ç¤º</span>
            {% else %}
                <a href="{% url 'tab_rsi' %}" class="px-4 py-2 bg-white rounded shadow hover:bg-indigo-100">RSI è­¦ç¤º</a>
            {% endif %}

            {% if path == '/core/bband/' %}
                <span class="px-4 py-2 bg-white border-b-4 border-indigo-500 text-indigo-700 font-bold rounded shadow">å¸ƒæ—é€šé“</span>
            {% else %}
                <a href="{% url 'tab_bband' %}" class="px-4 py-2 bg-white rounded shadow hover:bg-indigo-100">å¸ƒæ—é€šé“</a>
            {% endif %}

            {% if path == '/core/macd/' %}
                <span class="px-4 py-2 bg-white border-b-4 border-indigo-500 text-indigo-700 font-bold rounded shadow">MACD é»ƒé‡‘äº¤å‰</span>
            {% else %}
                <a href="{% url 'tab_macd' %}" class="px-4 py-2 bg-white rounded shadow hover:bg-indigo-100">MACD é»ƒé‡‘äº¤å‰</a>
            {% endif %}

            {% if path == '/core/drop/' %}
                <span class="px-4 py-2 bg-white border-b-4 border-indigo-500 text-indigo-700 font-bold rounded shadow">ä¸€æœˆå…§è·Œå¹…è¶…é 30%</span>
            {% else %}
                <a href="{% url 'tab_drop' %}" class="px-4 py-2 bg-white rounded shadow hover:bg-indigo-100">ä¸€æœˆå…§è·Œå¹…è¶…é 30%</a>
            {% endif %}
        {% endwith %}
    </div>

    <!-- ä¸»å…§å®¹å€å¡Š -->
    <main class="p-4 max-w-full overflow-x-auto">
    <table class="min-w-[1000px] w-full text-sm text-left text-gray-700">
        <thead class="bg-indigo-100 text-gray-800">
            <tr>
                {% for col in column_headers %}
                <th class="px-4 py-2 cursor-pointer select-none" onclick="sortTable({{ forloop.counter0 }})">
                    {{ col }}
                    <span id="arrow-{{ forloop.counter0 }}"></span>
                </th>
                {% endfor %}
            </tr>
        </thead>
        <tbody id="stock-table-body">
            {% for stock in stocks %}
            <tr class="{% if stock.dividend == 0 %}bg-red-50{% endif %} border-b">
                <td class="px-4 py-2 font-semibold text-blue-700 hover:underline">
                    <a href="{% url 'stock_detail' stock.symbol %}">{{ stock.symbol }}</a>
                </td>
                <td class="px-4 py-2">{{ stock.close }}</td>
                <td class="px-4 py-2 {% if stock.dividend == 'N/A' %}text-gray-400{% endif %}">{{ stock.ex_dividend_date }}</td>
                <td class="px-4 py-2 {% if stock.dividend == 0 or stock.dividend == '0' or stock.dividend == 'N/A' %}text-gray-400{% endif %}">{{ stock.dividend }}</td>
                <td class="px-4 py-2 {% if stock.dividend_ratio == 0 or stock.dividend_ratio == '0' or stock.dividend_ratio == 'N/A' %}text-gray-400{% endif %}">
                    {{ stock.dividend_ratio }}
                    {% if stock.dividend_ratio != 'N/A' %}
                        %
                    {% endif %}
                </td>
                <td class="px-4 py-2 {% if stock.yield == 0 or stock.yield == '0' or stock.yield == 'N/A' %}text-gray-400{% endif %}">
                    {{ stock.yield }}%
                </td>
                <td class="px-4 py-2 {% if stock.daily_change|floatformat:2 < alert_change|floatformat:2 and stock.daily_change|floatformat:2 < 0 %}text-yellow-600 font-bold{% endif %}">
                    {{ stock.price_change }}%
                </td>
                <td class="px-4 py-2">{{ stock.year_low }}</td>
                <td class="px-4 py-2">{{ stock.year_high }}</td>
                <td class="px-4 py-2 
                    {% if stock.rsi > rsi_high_warn %}text-red-600
                    {% elif stock.rsi > rsi_high_soft %}text-orange-500
                    {% elif stock.rsi < rsi_low_warn %}text-red-600
                    {% elif stock.rsi < rsi_low_soft %}text-blue-500
                    {% endif %}">
                    {{ stock.rsi }}
                </td>
                <td class="px-4 py-2 {% if stock.volume_delta > alert_volume %}bg-yellow-100{% endif %}">{{ stock.volume_delta }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</main>

<!-- ğŸ”½ è¡¨æ ¼æ’åºåŠŸèƒ½ -->
<script>
    let sortOrder = 1;
    let lastSortedColumn = -1;

    function sortTable(colIndex) {
        const table = document.getElementById("stock-table-body");
        const rows = Array.from(table.rows);

        if (lastSortedColumn === colIndex) {
            sortOrder *= -1; // åå‘æ’åº
        } else {
            sortOrder = 1;
        }
        lastSortedColumn = colIndex;

        rows.sort((a, b) => {
            const aText = a.cells[colIndex].innerText.trim();
            const bText = b.cells[colIndex].innerText.trim();

            const aVal = parseFloat(aText.replace('%','')) || aText;
            const bVal = parseFloat(bText.replace('%','')) || bText;

            return sortOrder * (aVal > bVal ? 1 : aVal < bVal ? -1 : 0);
        });

        rows.forEach(row => table.appendChild(row));

        // é‡è¨­æ‰€æœ‰ç®­é ­
        document.querySelectorAll('[id^=arrow-]').forEach(el => el.innerHTML = '');
        document.getElementById(`arrow-${colIndex}`).innerHTML = sortOrder === 1 ? 'â†‘' : 'â†“';
    }
</script>

</body>
</html>
